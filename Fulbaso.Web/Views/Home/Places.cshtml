@using Fulbaso.Contract
@using Fulbaso.UI

@model IEnumerable<Place>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var query = !string.IsNullOrEmpty(Request.QueryString["q"]) && Request.QueryString["q"] != "*" ? ("para \"" + Request.QueryString["q"] + "\"") : "";
    
    var players = (Request.QueryString["j"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s));
    var locations = (Request.QueryString["l"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s));
    var floors = (Request.QueryString["s"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s)).Select(i => Convert.ToInt32(i));
    var ind = Convert.ToBoolean(Request.QueryString["ind"] ?? "False");
    var lig = Convert.ToBoolean(Request.QueryString["lig"] ?? "False");
    var advanced = false;
    
    if (players.Count() > 0 || locations.Count() > 0 || floors.Count() > 0 || Request.QueryString["ind"] != null || Request.QueryString["lig"] != null)
    {
        advanced = true;
        query = string.Empty;
        if (players.Count() > 0)
        {
            query += "para " + InterfaceUtil.GetJoin(players) + " jugadores, ";
        }

        if (locations.Count() > 0)
        {
            query += "en " + InterfaceUtil.GetJoin(locations) + ", ";
        }

        if (floors.Count() > 0)
        {
            query += "con " + CoreUtil.GetFloors(floors) + ", ";
        }

        if (ind)
        {
            query += "techada, ";
        }

        if (ind)
        {
            query += "con luz, ";
        }

        query = query.Length > 0 ? (query.Substring(0, query.Length - 2) + ".") : "";
    }
}

<div style="padding: 0.2em 0px;">
    <p><span class="@(ViewBag.Places > 0 ? "badge badge-success" : "badge badge-error")">@ViewBag.Places</span> complejos encontrados @query</p>
    @if (advanced)
    {
        <p>Haga click @Html.ActionLink("aquí", "Advanced", "Search") para realizar una nueva búsqueda.</p>
    }
</div>

<div class="container-fluid">
    <div class="row">
        <div class="span8">
            <div id="places">
                @Html.Partial("List", Model)
            </div>
        </div>
        <div class="span4">
            <div class="hidden-phone">
            @{
                var tags = ViewBag.Tags as IEnumerable<Tuple<string, int>>;
                tags = tags.OrderByDescending(t => t.Item2).Take(20).OrderBy(t => t.Item1);
                var min = tags.Min(i => i.Item2);
                var max = tags.Max(i => i.Item2);
                var minfont = 12;
                var maxfont = 24;
                
                foreach (var i in tags)
                {
                    var fontsize = (minfont + ((i.Item2 / max) * (maxfont - minfont)));
                    <span style="font-size: @(fontsize)px;">@i.Item1</span>
                }
            }
            sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />sidebar<br />
            </div>
        </div>
    </div>
</div>
<a id="loadmore" class="btn btn-primary" style="margin-left: 20px; width: 16em;">Mostrar más</a>

<script>
    $(function () {
        var last;
        function loadMore() {
            var init = $(".place-info").length;

            if (init != last) {
                last = init;

                $("#loadmore").hide();
                $.get("@Html.Raw(Url.Action("List", "Home", new { q = Request.QueryString["q"], j = Request.QueryString["j"], l = Request.QueryString["l"], s = Request.QueryString["s"], ind = Request.QueryString["ind"], lig = Request.QueryString["lig"], }))&init=" + init, function (data) { 
                    $("#loadmore").removeClass("disabled");
                    $(data)
                        .hide()
                        .appendTo("#places")
                        .fadeIn();
                    $("#loadmore").show();

                    if ($(".place-info").length == @ViewBag.Places) {
                        $("#loadmore").hide();
                    }
                });
            }
        }

        $("#loadmore").click(function () {
            loadMore();
        });

        $(window).scroll(function () {
            if (document.documentElement.clientHeight + $(document).scrollTop() >= document.body.offsetHeight - 100) {
                loadMore();
            }
        });
        
        loadMore();
    });
</script>