@using Fulbaso.Contract
@using Fulbaso.UI

@model IEnumerable<Place>

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var query = !string.IsNullOrEmpty(Request.QueryString["q"]) && Request.QueryString["q"] != "*" ? ("para \"" + Request.QueryString["q"] + "\"") : "";
    
    var players = (Request.QueryString["j"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s));
    var locations = (Request.QueryString["l"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s));
    var floors = (Request.QueryString["s"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s)).Select(i => Convert.ToInt32(i));
    var ind = Convert.ToBoolean(Request.QueryString["ind"] ?? "False");
    var lig = Convert.ToBoolean(Request.QueryString["lig"] ?? "False");
    
    if (players.Count() > 0 || locations.Count() > 0 || floors.Count() > 0 || Request.QueryString["ind"] != null || Request.QueryString["lig"] != null)
    {
        query = string.Empty;
        if (players.Count() > 0)
        {
            query += "para " + InterfaceUtil.GetJoin(players) + " jugadores, ";
        }

        if (locations.Count() > 0)
        {
            query += "en " + InterfaceUtil.GetJoin(locations) + ", ";
        }

        if (floors.Count() > 0)
        {
            query += "con " + CoreUtil.GetFloors(floors) + ", ";
        }

        if (ind)
        {
            query += "techada, ";
        }

        if (ind)
        {
            query += "con luz, ";
        }

        query = query.Length > 0 ? (query.Substring(0, query.Length - 2) + ".") : "";
    }
}

<div style="padding: 0.2em 0px;">
    <p><span class="@(ViewBag.Places > 0 ? "badge badge-success" : "badge badge-error")">@ViewBag.Places</span> complejos encontrados @query</p>
</div>

<div id="places">
    @Html.Partial("List", Model)
</div>

<a id="loadmore" class="btn btn-primary" style="margin-left: 20px; width: 16em;">Mostrar más</a>

<script>
    $(function () {
        var last;
        function loadMore() {
            var init = $(".place-info").length;

            if (init != last) {
                last = init;

                $("#loadmore").hide();
                $.get("@Html.Raw(Url.Action("List", "Home", new { q = Request.QueryString["q"], j = Request.QueryString["j"], l = Request.QueryString["l"], s = Request.QueryString["s"], ind = Request.QueryString["ind"], lig = Request.QueryString["lig"], }))&init=" + init, function (data) { 
                    $("#loadmore").removeClass("disabled");
                    $(data)
                        .hide()
                        .appendTo("#places")
                        .fadeIn();
                    $("#loadmore").show();

                    if ($(".place-info").length == @ViewBag.Places) {
                        $("#loadmore").hide();
                    }

                    $('.place-info').unbind('hover');
                    $('.place-info').hover(function () { 
                        $(this).animate({
                            borderTopColor: '#999',
                            borderLeftColor: '#999',
                            borderBottomColor: '#999',
                            borderRightColor: '#999'
                        }, 300);
                    }, function () {
                        $(this).animate({
                            borderTopColor: '#fff',
                            borderLeftColor: '#fff',
                            borderBottomColor: '#fff',
                            borderRightColor: '#fff'
                        }, 100);
                    });
                });
            }
        }

        $("#loadmore").click(function () {
            loadMore();
        });

        $(window).scroll(function () {
            if (document.documentElement.clientHeight + $(document).scrollTop() >= document.body.offsetHeight - 100) {
                loadMore();
            }
        });
        
        loadMore();
    });
</script>