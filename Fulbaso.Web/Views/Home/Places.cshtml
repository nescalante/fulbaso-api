@using Fulbaso.Contract
@using Fulbaso.UI

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var query = !string.IsNullOrEmpty(Request.QueryString["q"]) && Request.QueryString["q"] != "*" ? ("para \"" + Request.QueryString["q"] + "\"") : "";
    
    var players = (Request.QueryString["j"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s));
    var locations = (Request.QueryString["l"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s));
    var floors = (Request.QueryString["s"] ?? "").Split(';').Where(s => !string.IsNullOrEmpty(s)).Select(i => Convert.ToInt32(i));
    var ind = Convert.ToBoolean(Request.QueryString["ind"] ?? "False");
    var lig = Convert.ToBoolean(Request.QueryString["lig"] ?? "False");
    
    if (players.Count() > 0 || locations.Count() > 0 || floors.Count() > 0 || Request.QueryString["ind"] != null || Request.QueryString["lig"] != null)
    {
        query = string.Empty;
        if (players.Count() > 0)
        {
            query += "para " + InterfaceUtil.GetJoin(players) + " jugadores, ";
        }

        if (locations.Count() > 0)
        {
            query += "en " + InterfaceUtil.GetJoin(locations) + ", ";
        }

        if (floors.Count() > 0)
        {
            query += "con " + CoreUtil.GetFloors(floors) + ", ";
        }

        if (ind)
        {
            query += "techada, ";
        }

        if (ind)
        {
            query += "con luz, ";
        }

        query = query.Length > 0 ? (query.Substring(0, query.Length - 2) + ".") : "";
    }
}

<div style="padding: 0.2em 0px;">
    <p><span class="@(ViewBag.Places > 0 ? "badge badge-success" : "badge badge-error")">@ViewBag.Places</span> complejos encontrados @query</p>
</div>

<div id="places"></div>

<a id="loadmore" class="btn btn-primary" style="margin-left: 20px; width: 16em;">Mostrar más</a>

<script>
    $(function () {
        function loadMore() {
            $("#loadmore").addClass("disabled");
            $("#loadmore").html("Buscando");

            $.get("@Url.Action("List", "Home")?init=" + $(".place-info").length + "&query=@ViewBag.Query", function (data) { 
                $("#loadmore").removeClass("disabled");
                $(data)
                    .hide()
                    .appendTo("#places")
                    .fadeIn();

                if ($(".place-info").length == @ViewBag.Places) {
                    $("#loadmore").hide();
                }
            }).error(function () {
                $("#loadmore").hide();
            });
            $("#loadmore").html("Mostrar más");
        }

        $("#loadmore").click(function () {
            loadMore();
        });

        $(window).scroll(function () {
            if (document.documentElement.clientHeight + $(document).scrollTop() >= document.body.offsetHeight) {
                loadMore();
            }
        });
        
        loadMore();
    });
</script>